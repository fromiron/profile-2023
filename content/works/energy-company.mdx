---
title: "地元エナジー会社マイページ・アプリ"
image: /works/energy-company/cover.png
tags:
  - Cordova
  - cakePHP
  - Vue.js
  - SCSS
  - mariaDB
  - Frontend
  - Backend
  - App
  - Server
description: "地元エナジー会社マイページ・アプリの開発を担当しました。"
author: "J.Lee"
isPublished: true
createdAt: 2023-09-08
updatedAt: 2023-09-08
publishedAt: 2023-09-08
---

# 1.プロジェクトの概要
既存開発されたWebマイページ・アプリの追加開発及びメンテナンス・サーバー管理など

## 1.1 プロジェクト基本情報
- プロジェクト期間: **2022年12月 - 2023年8月**
- クライアント: 地元エナジー会社
- 役割: PHP・Cordovaエンジニア
- チーム構成: 1人(案件によって他社とのもあり)

## 1.2 開発環境
1. Windows 10(WSL2@Ubuntu 20.04)
2. MacOS
3. PhpStorm
4. Bitbucket
5. Docker

## 1.3 使用言語/FW/ライブラリ
- PHP5.6→7.3(8系を提案しましたが、クライアント様が7系指定)
- cakePHP3.5→3.10
- Context API
- Cordova

# 2. 開発案件
## 2.1 レスポンス高速化
dbの各テーブルには数万以上のデータがあり、複雑なjoin文が使用され、遅いAPIのレスポンスはもちろん、メモリーリークが発生し、サーバーが落ちることもありました。

メモリーリークの原因を調査したところ、複雑なクエリーにcakePHPのORMを使うとSQLの実行時間が長くなり、APIレスポンスタイムが遅くなっていました。
さらにcakePHPもPHPもかなり古いままサービスを起動していましたので**バージョンアップでAPIレスポンスタイムの改善**可能性があると判断しました。
そこで、SQLの実行時間を短縮するため、当時の最新バージョンへのマイグレーションを行い、同時に一部クエリはcakePHPの**ORMを使わずにSQLを直接実行**するように修正しました。

担当が何人か変わってきたプロジェクトだったため、DBのインデクシングにも漏れがあり、各リクエストに当てはまるよう**DBインデクシング**も追加で行いました。

最終的には一番遅かったAPIを基準として800ms～1200msのレスポンスタイムだったAPIが150ms～300msまで減り**4～7倍程度高速化**され目標を達成しました。

## 2.2 会員管理ロジック改善
毎日行われるバッチプロセスのロジックを修正し、入会・退会ユーザーの管理を改善しました。
新規入会メンバーがいる場合、自動メール自自動プロセスの追加やバッチプロセス実行前後のデータ合致確認自動化、再入会会員管理ロジック追加などを行いました。

## 2.3 CMSでのクーポンコード登録・管理機能開発
既存のクーポンコード登録機能は1つのコードを手動で登録する機能でしたが、数量限定クーポンコードを登録する機能を追加しました。
クーポンはcsvでアップロードし、登録前にJanCodeの重複・タイプをチェック、登録後に数量の合致チェックができます。ユーザーが一つ使うと、該当コードは使用済になり、使用ユーザー・時間などをロギングします。

## 2.4 灯油配達・灯油料金表示機能開発
他社との共同作業で、灯油タンクのセンターAPIは他社提供していただき、灯油配達・灯油料金表示機能（Web・App）の開発を担当しました。
残量量に合わせてタンクのイメージが変わるなどの機能が実装されました。

開発時に使われていたCordovaとosプラグインが古かったため、アプリ登録審査に通らない可能性があると判断し、Cordovaのバージョンアップを行いました。
この作業ではネイティブコードでの無理やり追加されていたカスタムプラグインが問題になってビルドすらできない状態になりましたが、コードのレファレンスが不分明だったため、
Cordovaのバージョンアップに伴うネイティブコードの変更箇所を調査し、作動が確認されたプラグインへのマイグレーションを行いました。

iOSの方はXcodeのビルド設定を新しくする必要があり、cordova-iosプラグインのバージョンアップに伴うビルド設定の変更を行いました。
Androidもgradleの設定を直接する必要があり、gradleファイルの読み方やカスタム（build-extras.gradleの追加など）の経験を得ました。

提供されたAPIはAzureを使っていて**コールドスタートイシュー**が発生し、毎朝の最初1回目のレスポンスが数千msになったり、APIのレスポンスタイムが遅くなることがありました。
この問題はEndpointへPingを周期的に送ってもらうように依頼し、**レスポンスタイムを改善**しました。

始めての会社間コラボレーションだったため、共有文書の作成やドキュメント化が大変でしたが、最終的には無事にリリースされました。

## 3. 成果
- PHP知識の向上
- CentOSのサーバー管理経験
- DBインデクシングによるレスポンス高速化
- CordovaのプラグインアップデートによるAndroid/iOS知識の向上
- コラボレーション用仕様書の読み、作成経験